<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <link rel="stylesheet" href="/css/style.css">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .section-title {
            margin: 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #2c3e50;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background: #2c3e50;
            color: white;
        }

        .data-table tr:hover {
            background: #f5f5f5;
        }

        .action-btn {
            padding: 5px 10px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            margin-right: 5px;
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .add-btn {
            background: #2ecc71;
            color: white;
            padding: 10px 20px;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #ecf0f1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .tab-btn.active {
            background: #2c3e50;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-cog"></i> Panel de Administración</h1>
            <div style="display:flex; align-items:center; gap:16px; justify-content:space-between;">
                <p style="margin:0">Bienvenido, <%= admin %></p>
                <div>
                    <!-- Botón para abrir Mis Cursos en nueva pestaña manteniendo la sesión -->
                    <a href="/dashboard" target="_blank" rel="noopener noreferrer" class="add-btn" title="Ver mis cursos en nueva pestaña">Ir a Mis Cursos</a>
                </div>
            </div>
        </div>

        <div class="admin-stats">
            <div class="stat-card">
                <h3>Total Usuarios</h3>
                <p><%= stats.totalUsuarios %></p>
            </div>
            <div class="stat-card">
                <h3>Total Cursos</h3>
                <p><%= stats.totalCursos %></p>
            </div>
            <div class="stat-card">
                <h3>Ventas Totales</h3>
                <p>$<%= stats.ventasTotales %></p>
            </div>
            <div class="stat-card">
                <h3>Ventas del Mes</h3>
                <p>$<%= stats.ventasMes %></p>
            </div>
        </div>

        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showTab('usuarios')">Usuarios</button>
                <button class="tab-btn" onclick="showTab('cursos')">Cursos</button>
                <button class="tab-btn" onclick="showTab('ventas')">Ventas</button>
                <button class="tab-btn" onclick="showTab('resenas')">Reseñas</button>
            </div>

            <!-- Tab de Usuarios -->
            <div id="usuarios" class="tab-content active">
                <h2 class="section-title">Gestión de Usuarios</h2>
                <button class="add-btn" onclick="showModal('usuario')">
                    <i class="fas fa-plus"></i> Agregar Usuario
                </button>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% usuarios.forEach(function(usuario) { %>
                        <tr data-id="<%= usuario.id %>" data-nombre="<%= usuario.nombre.replace(/\"/g, '&quot;') %>" data-email="<%= usuario.email.replace(/\"/g, '&quot;') %>" data-rol="<%= usuario.rol %>">
                            <td><%= usuario.id %></td>
                            <td><%= usuario.nombre %></td>
                            <td><%= usuario.email %></td>
                            <td><%= usuario.rol %></td>
                            <td>
                                <button class="action-btn edit-btn" onclick="editarUsuario('<%= usuario.id %>')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="eliminarUsuario('<%= usuario.id %>')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <!-- Tab de Cursos -->
            <div id="cursos" class="tab-content">
                <h2 class="section-title">Gestión de Cursos</h2>
                <button class="add-btn" onclick="showModal('curso','add')">
                    <i class="fas fa-plus"></i> Agregar Curso
                </button>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Descripción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% cursos.forEach(function(curso) { %>
                        <tr data-id="<%= curso.id %>" data-nombre="<%= curso.nombre.replace(/\"/g, '&quot;') %>" data-precio="<%= curso.precio %>" data-descripcion="<%= (curso.descripcion || '').replace(/\"/g, '&quot;') %>" data-urlvideo="<%= (curso.urlVideo || '').replace(/\"/g, '&quot;') %>">
                            <td><%= curso.id %></td>
                            <td><%= curso.nombre %></td>
                            <td>$<%= curso.precio %></td>
                            <td><%= curso.descripcion ? (curso.descripcion.length > 60 ? curso.descripcion.substring(0,57) + '...' : curso.descripcion) : '' %></td>
                            <td>
                                <button class="action-btn edit-btn" onclick="editarCurso('<%= curso.id %>')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="eliminarCurso('<%= curso.id %>')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <!-- Tab de Ventas -->
            <div id="ventas" class="tab-content">
                <h2 class="section-title">Registro de Ventas</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Curso</th>
                            <th>Fecha</th>
                            <th>Monto</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% ventas.forEach(function(venta) { %>
                        <tr>
                            <td><%= venta.id %></td>
                            <td><%= venta.usuario %></td>
                            <td><%= venta.curso %></td>
                            <td><%= venta.fecha %></td>
                            <td>$<%= venta.monto %></td>
                            <td><%= venta.estado %></td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>

            <!-- Tab de Reseñas (Admin) -->
            <div id="resenas" class="tab-content">
                <h2 class="section-title">Reseñas</h2>
                <p>Desde aquí puedes revisar y eliminar reseñas publicadas por los usuarios.</p>
                <table class="data-table" id="tablaResenas">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Curso</th>
                            <th>Calificación</th>
                            <th>Comentario</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filas cargadas dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar usuario -->
    <div id="modalUsuario" class="modal">
        <div class="modal-content">
            <h2 id="modalUsuarioTitle">Agregar Usuario</h2>
            <form id="formUsuario" onsubmit="guardarUsuario(event)">
                <div class="form-group">
                    <label for="nombre">Nombre:</label>
                    <input type="text" id="nombre" name="nombre" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="rol">Rol:</label>
                    <select id="rol" name="rol" required>
                        <option value="usuario">Usuario</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="password">Contraseña:</label>
                    <input type="password" id="password" name="password">
                </div>
                <button type="submit" class="add-btn">Guardar</button>
                <button type="button" class="action-btn delete-btn" onclick="closeModal('usuario')">Cancelar</button>
            </form>
        </div>
    </div>

    <!-- Modal para agregar/editar curso -->
    <div id="modalCurso" class="modal">
        <div class="modal-content">
            <h2 id="modalCursoTitle">Agregar Curso</h2>
            <form id="formCurso" onsubmit="guardarCurso(event)">
                <div class="form-group">
                    <label for="nombreCurso">Nombre del Curso:</label>
                    <input type="text" id="nombreCurso" name="nombreCurso" required>
                </div>
                <div class="form-group">
                    <label for="precio">Precio:</label>
                    <input type="number" id="precio" name="precio" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="descripcion">Descripción:</label>
                    <textarea id="descripcion" name="descripcion" required></textarea>
                </div>
                <div class="form-group">
                    <label for="urlVideo">URL del video (embed URL):</label>
                    <input type="text" id="urlVideo" name="urlVideo" placeholder="https://www.youtube.com/embed/VIDEO_ID" />
                </div>
                <div class="form-group">
                    <label for="estado">Estado:</label>
                    <select id="estado" name="estado" required>
                        <option value="activo">Activo</option>
                        <option value="inactivo">Inactivo</option>
                    </select>
                </div>
                <button type="submit" class="add-btn">Guardar</button>
                <button type="button" class="action-btn delete-btn" onclick="closeModal('curso')">Cancelar</button>
            </form>
        </div>
    </div>

    <script>
        function showTab(tabId) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // Desactivar todos los botones
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar el contenido seleccionado
            document.getElementById(tabId).classList.add('active');
            // Activar el botón seleccionado
            event.target.classList.add('active');
        }

        function showModal(type, mode) {
            const modal = document.getElementById(`modal${type.charAt(0).toUpperCase() + type.slice(1)}`);
            // Si abrimos el modal de curso en modo 'add', limpiar campos y quitar edit state
            if (type === 'curso' && mode === 'add') {
                const form = document.getElementById('formCurso');
                form.reset();
                delete form.dataset.editId;
                document.getElementById('modalCursoTitle').innerText = 'Agregar Curso';
            }
            modal.style.display = 'block';
        }

        function closeModal(type) {
            document.getElementById(`modal${type.charAt(0).toUpperCase() + type.slice(1)}`).style.display = 'none';
        }

        async function guardarUsuario(event) {
            event.preventDefault();
            const nombre = document.getElementById('nombre').value.trim();
            const email = document.getElementById('email').value.trim();
            const rol = document.getElementById('rol').value;
            const password = document.getElementById('password').value;
            const form = document.getElementById('formUsuario');
            const editId = form.dataset.editId;

            if (!nombre || !email || !rol) {
                alert('Por favor completa todos los campos requeridos.');
                return;
            }

            // Si estamos editando y no hay contraseña, no la enviamos
            const data = {
                nombre,
                email,
                rol
            };
            if (password) data.password = password;

            try {
                const method = editId ? 'PUT' : 'POST';
                const url = editId ? `/api/usuarios/${editId}` : '/api/usuarios';

                const response = await fetch(url, {
                    method,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Error guardando usuario:', errorData);
                    alert('No se pudo guardar el usuario. Por favor revisa la consola para más detalles.');
                    return;
                }

                // Éxito: cerrar modal y recargar para ver cambios
                delete form.dataset.editId;
                closeModal('usuario');
                location.reload();
            } catch (error) {
                console.error('Error en request guardarUsuario:', error);
                alert('Ocurrió un error al guardar el usuario. Por favor revisa la consola.');
            }
        }

        async function guardarCurso(event) {
            event.preventDefault();
            const nombreCurso = document.getElementById('nombreCurso').value.trim();
            const precio = document.getElementById('precio').value;
            const descripcion = document.getElementById('descripcion').value.trim();
            let urlVideo = document.getElementById('urlVideo')?.value?.trim() || '';
            const estado = document.getElementById('estado').value; // actualmente no usado en backend

            if (!nombreCurso || !precio || !descripcion) {
                alert('Completa nombre, precio y descripción.');
                return;
            }

            const form = document.getElementById('formCurso');
            const editId = form.dataset.editId;
            const method = editId ? 'PUT' : 'POST';
            const url = editId ? `/api/cursos/${editId}` : '/api/cursos';

            try {
                // Normalizar distintos formatos que el admin puede pegar:
                // - iframe completo: extraer src
                // - vimeo.com/ID o share link: convertir a player.vimeo.com/video/ID
                if (urlVideo.includes('<iframe')) {
                    const tmp = document.createElement('div');
                    tmp.innerHTML = urlVideo;
                    const iframe = tmp.querySelector('iframe');
                    if (iframe && iframe.src) urlVideo = iframe.src;
                }

                // Si pegó un enlace de Vimeo (p.ej. https://vimeo.com/1134432436?share=copy), extraer ID
                try {
                    const v = new URL(urlVideo);
                    if ((v.hostname && v.hostname.includes('vimeo.com')) && !v.hostname.includes('player.vimeo.com')) {
                        // pathname puede tener /ID o /channels/.../ID
                        const parts = v.pathname.split('/').filter(Boolean);
                        const maybeId = parts[parts.length - 1];
                        if (/^\d+$/.test(maybeId)) {
                            urlVideo = `https://player.vimeo.com/video/${maybeId}`;
                        }
                    }
                } catch (e) {
                    // no es una URL válida, ignorar
                }

                const resp = await fetch(url, {
                    method,
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nombreCurso, precio, descripcion, estado, urlVideo })
                });

                if (!resp.ok) {
                    const data = await resp.json().catch(() => ({}));
                    console.error('Error guardando/actualizando curso:', data);
                    alert('No se pudo guardar el curso. Revisa la consola para más detalles.');
                    return;
                }

                // Success: cerrar modal y recargar para ver cambios
                delete form.dataset.editId;
                closeModal('curso');
                location.reload();
            } catch (err) {
                console.error('Error en request guardarCurso:', err);
                alert('Ocurrió un error al guardar el curso. Revisa la consola.');
            }
        }

        function editarUsuario(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) {
                console.error('No se encontró la fila del usuario');
                return;
            }
            
            const nombre = row.dataset.nombre || '';
            const email = row.dataset.email || '';
            const rol = row.dataset.rol || 'usuario';

            document.getElementById('nombre').value = nombre;
            document.getElementById('email').value = email;
            document.getElementById('rol').value = rol === 'Administrador' ? 'admin' : 'usuario';
            document.getElementById('password').value = ''; // Limpiar contraseña
            
            const form = document.getElementById('formUsuario');
            form.dataset.editId = id;
            document.getElementById('modalUsuarioTitle').innerText = 'Editar Usuario';
            showModal('usuario');
        }

        async function eliminarUsuario(id) {
            if(!confirm('¿Estás seguro de que deseas eliminar este usuario?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/usuarios/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Error eliminando usuario:', errorData);
                    alert('No se pudo eliminar el usuario. Por favor revisa la consola para más detalles.');
                    return;
                }

                location.reload();
            } catch (error) {
                console.error('Error en request eliminarUsuario:', error);
                alert('Ocurrió un error al eliminar el usuario. Por favor revisa la consola.');
            }
        }

        function editarCurso(id) {
            // Rellenar campos desde el row data-attributes
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return alert('No se encontró el curso en la lista');
            const nombre = row.dataset.nombre || '';
            const precio = row.dataset.precio || '';
            const descripcion = row.dataset.descripcion || '';
            const urlVideo = row.dataset.urlvideo || '';

            document.getElementById('nombreCurso').value = nombre;
            document.getElementById('precio').value = precio;
            document.getElementById('descripcion').value = descripcion;
            document.getElementById('urlVideo').value = urlVideo;

            const form = document.getElementById('formCurso');
            form.dataset.editId = id;
            document.getElementById('modalCursoTitle').innerText = 'Editar Curso';
            showModal('curso');
        }

        async function eliminarCurso(id) {
            if (!confirm('¿Estás seguro de que deseas eliminar este curso?')) return;
            try {
                const resp = await fetch(`/api/cursos/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                if (!resp.ok) {
                    const data = await resp.json().catch(() => ({}));
                    console.error('Error eliminando curso:', data);
                    alert('No se pudo eliminar el curso. Revisa la consola.');
                    return;
                }
                location.reload();
            } catch (err) {
                console.error('Error en request eliminarCurso:', err);
                alert('Ocurrió un error al eliminar el curso. Revisa la consola.');
            }
        }

        // --- Gestión de reseñas (admin) ---
        async function cargarResenasAdmin() {
            try {
                const resp = await fetch('/admin/resenas', { credentials: 'include' });
                if (!resp.ok) {
                    console.error('Error cargando reseñas admin');
                    return;
                }
                const data = await resp.json();
                const tbody = document.querySelector('#tablaResenas tbody');
                tbody.innerHTML = '';
                (data.resenas || []).forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${r.id}</td>
                        <td>${escapeHtml((r.nombrePersona ? (r.nombrePersona + ' ' + (r.apellidoPersona||'')) : r.usuarioEmail) || 'Usuario')}</td>
                        <td>${escapeHtml(r.cursoNombre || ('#' + (r.cursoId || '')))}</td>
                        <td>${r.calificacion}</td>
                        <td>${escapeHtml(r.comentario || '')}</td>
                        <td>
                            <button class="action-btn delete-btn" onclick="eliminarResenaAdmin(${r.id})">Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Error en cargarResenasAdmin:', err);
            }
        }

        async function eliminarResenaAdmin(id) {
            if (!confirm('¿Eliminar reseña #' + id + '? Esta acción no puede deshacerse.')) return;
            try {
                const resp = await fetch('/admin/resenas/' + id, { method: 'DELETE', credentials: 'include' });
                if (!resp.ok) {
                    const data = await resp.json().catch(() => ({}));
                    alert('No se pudo eliminar la reseña: ' + (data.error || resp.status));
                    return;
                }
                cargarResenasAdmin();
            } catch (err) {
                console.error('Error en eliminarResenaAdmin:', err);
                alert('Error al eliminar reseña. Revisa la consola.');
            }
        }

        // Helper para escapar HTML simple
        function escapeHtml(str) {
            return (str + '').replace(/[&<>"]+/g, function(match) {
                switch(match) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    default: return match;
                }
            });
        }

        // Cargar reseñas cuando se entra a la pestaña
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = (btn.getAttribute('onclick') || '').match(/showTab\('([^']+)'\)/);
                if (target && target[1] === 'resenas') {
                    // espera un tick para que la tab se muestre
                    setTimeout(cargarResenasAdmin, 50);
                }
            });
        });
    </script>
</body>
</html>